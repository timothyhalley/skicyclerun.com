---
// filepath: src/layouts/Posts.astro
import type { CollectionEntry } from "astro:content";
import BaseLayout from "@layouts/BaseLayout.astro";
import Breadcrumbs from "@layouts/Breadcrumbs.astro";
import Header from "@components/Header.astro";
import Pagination from "@components/Pagination.astro";
import PostCard from "@components/PostCards.astro";
import { SkiCycleRunConfig } from "skicyclerun.config";
import { getPhotoCover } from "@utils/getPhotoCover";
import { getBlogSection } from "@constants/blogTypes";

export interface Props {
  currentPage: number;
  totalPages: number;
  paginatedPosts: CollectionEntry<"blog">[];
  prevUrl?: string;
  nextUrl?: string;
}

const { currentPage, totalPages, paginatedPosts, prevUrl, nextUrl } =
  Astro.props;

// Detect section using the helper function
const section = getBlogSection(paginatedPosts[0]?.data?.type);

// Fetch cover images for all posts
const coverImages = await Promise.all(
  paginatedPosts.map((post) =>
    getPhotoCover(post.data.cover ?? "images/default-cover.png")
  )
);
console.log(
  `[Posts.astro] Loaded cover images for ${coverImages.length} posts.`
);
---

<BaseLayout
  title={`${section === "tech" ? "Tech" : "Posts"} | ${SkiCycleRunConfig.title}`}
>
  <Header activeNav={section} />
  <Breadcrumbs
    pageTitle={section === "tech" ? "Tech" : "Posts"}
    pageDesc={section === "tech"
      ? "Technical articles and tutorials"
      : "All the articles I've posted."}
  >
    <div class="flex flex-col gap-6">
      {
        paginatedPosts.map((post, index) => (
          <PostCard
            title={post.data.title}
            author={post.data.author}
            pubDatetime={post.data.pubDatetime.toISOString()}
            tags={post.data.tags}
            description={post.data.description}
            cover={coverImages[index]?.src ?? "images/default-cover.png"}
            href={`/${section}/${post.slug}`}
          />
        ))
      }
    </div>

    <Pagination
      {currentPage}
      {totalPages}
      prevUrl={prevUrl || ""}
      nextUrl={nextUrl || ""}
    />
  </Breadcrumbs>
</BaseLayout>
