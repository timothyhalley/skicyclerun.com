---
interface SearchItem {
  title: string;
  description: string;
  tags: string[];
  bodySnippet?: string;
  slug: string;
  url?: string;
}

interface Props {
  searchList: SearchItem[];
}
const { searchList } = Astro.props as Props;
---

<label class="relative block">
  <span class="absolute inset-y-0 left-0 flex items-center pl-2 opacity-75">
    <svg
      xmlns="http://www.w3.org/2000/svg"
      aria-hidden="true"
      class="h-5 w-5"
      viewBox="0 0 24 24"
    >
      <path
        fill="currentColor"
        d="M19.023 16.977a35.13 35.13 0 0 1-1.367-1.384c-.372-.378-.596-.653-.596-.653l-2.8-1.337A6.962 6.962 0 0 0 16 9c0-3.859-3.14-7-7-7S2 5.141 2 9s3.14 7 7 7c1.763 0 3.37-.66 4.603-1.739l1.337 2.8s.275.224.653.596c.387.363.896.854 1.384 1.367l1.358 1.392.604.646 2.121-2.121-.646-.604c-.379-.372-.885-.866-1.391-1.36zM9 14c-2.757 0-5-2.243-5-5s2.243-5 5-5 5 2.243 5 5-2.243 5-5 5z"
      ></path>
    </svg>
    <span class="sr-only">Search</span>
  </span>
  <input
    id="search-input"
    class="block w-full rounded border py-3 pl-10 pr-3"
    style="
      border-color: var(--color-skin-fill); 
      border-opacity: 0.4;
      background-color: var(--color-skin-fill);
    "
    placeholder="Search posts..."
    type="text"
    name="search"
    autocomplete="off"
    oninput="window.filterSearch()"
  />

  <style>
    #search-input::placeholder {
      font-style: italic;
      opacity: 0.75;
    }

    #search-input:focus {
      border-color: var(--color-skin-accent);
      outline: none;
    }
  </style>
</label>

<div id="search-results" class="mt-6 text-sm"></div>
<ul id="search-list" class="mt-4 space-y-4">
  {
    searchList.map((item) => (
      <li
        class="search-item"
        data-title={item.title}
        data-description={item.description}
        data-tags={item.tags.join(" ")}
        data-body={item.bodySnippet || ""}
      >
        <a href={item.url || `/posts/${item.slug}`}>
          <h2>{item.title}</h2>
          <p>{item.description}</p>
        </a>
      </li>
    ))
  }
</ul>

<script lang="ts">
  window.filterSearch = function () {
    const inputEl = document.getElementById("search-input");
    if (!inputEl) return;
    const input =
      typeof inputEl.value === "string"
        ? inputEl.value.toLowerCase().trim()
        : "";
    const items = document.querySelectorAll(".search-item");
    let found = 0;
    items.forEach((item) => {
      const el = /** @type {HTMLElement} */ (item);
      const text = [
        el.dataset?.title ?? "",
        el.dataset?.description ?? "",
        el.dataset?.tags ?? "",
        el.dataset?.body ?? "",
      ]
        .join(" ")
        .toLowerCase();
      if (input.length < 2 || text.includes(input)) {
        el.style.display = "";
        found++;
      } else {
        el.style.display = "none";
      }
    });
    const results = document.getElementById("search-results");
    if (results) {
      if (input.length > 1) {
        results.textContent = `Found ${found} ${found === 1 ? "result" : "results"} for '${input}'`;
      } else {
        results.textContent = "";
      }
    }
  };
</script>
