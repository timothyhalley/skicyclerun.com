---
import { getCollection } from "astro:content";
import BaseLayout from "@layouts/BaseLayout.astro";
import Header from "@components/Header.astro";
import Breadcrumbs from "@layouts/Breadcrumbs.astro";
import TravelGlobeComponent from "@components/TravelGlobe.tsx";
import travelFilter from "@utils/travelFilter";
import { getPhotoCover } from "@utils/getPhotoCover";

// 1. Fetch all blog posts
const posts = await getCollection("blog");

// 2. Filter for travel posts that have lat/lon coordinates
const travelPoints = posts
  .filter(travelFilter)
  .filter((post) => post.data.lat && post.data.lon)
  .map((post) => {
    // --- FIX: Pass the cover filename from frontmatter, not post.id ---
    const coverImageObject = getPhotoCover(post.data.cover);
    const coverImagePath = coverImageObject?.src ?? "/images/default-cover.png";

    return {
      lat: post.data.lat!,
      lng: post.data.lon!,
      name: post.data.title,
      slug: post.slug,
      author: post.data.author,
      pubDatetime: post.data.pubDatetime,
      tags: post.data.tags,
      description: post.data.description,
      cover: coverImagePath, // This is now guaranteed to be a string
      type: post.data.type,
    };
  });
---

<BaseLayout title="Travel Globe">
  <Header activeNav="travel" />
  <Breadcrumbs
    pageTitle="Travel Globe"
    pageDesc="Global view of places traveled and to be traveled! Click on the pins: ðŸ“"
  >
    <TravelGlobeComponent client:only="react" pointsData={travelPoints} />
  </Breadcrumbs>
</BaseLayout>
