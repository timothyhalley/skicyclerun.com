---
import { getCollection } from "astro:content";
import Posts from "@layouts/Posts.astro";
import PostDetails from "@layouts/PostDetails.astro";
import {
  generatePostStaticPaths,
  type PostPageProps,
} from "@utils/generatePostStaticPaths";
import { POSTS_TYPES } from "@constants/blogTypes";

// Generate static paths for all posts and pagination
export const prerender = true;

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const paths = generatePostStaticPaths(posts, POSTS_TYPES, "/posts");
  try {
    // Log the slugs being generated for /posts to help diagnose 404s like /posts/montreal-architecture
    const slugs = paths
      .filter((p: any) => p && p.params && typeof p.params.slug === "string")
      .map((p: any) => p.params.slug);
    console.log("[posts] getStaticPaths generated slugs:", slugs);
  } catch {}
  return paths;
}

const { post, page } = Astro.props as PostPageProps;
---

{
  post ? (
    <PostDetails post={post} />
  ) : page ? (
    <Posts
      paginatedPosts={page.data}
      currentPage={page.currentPage}
      totalPages={page.totalPages}
      prevUrl={page.url.prev}
      nextUrl={page.url.next}
    />
  ) : null
}
